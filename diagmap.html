<!DOCTYPE html>
<meta charset="utf-8">
<style>

.q0-9 { fill:rgb(247,251,255); }
.q1-9 { fill:rgb(222,235,247); }
.q2-9 { fill:rgb(198,219,239); }
.q3-9 { fill:rgb(158,202,225); }
.q4-9 { fill:rgb(107,174,214); }
.q5-9 { fill:rgb(66,146,198); }
.q6-9 { fill:rgb(33,113,181); }
.q7-9 { fill:rgb(8,81,156); }
.q8-9 { fill:rgb(8,48,107); }

.scroll-right {
    position: fixed;
    top: 1em;
    right: 1em;
}
.scroll-left {
    position: fixed;
    top: 1em;
    left: 1em;
}

</style>
<script src="resources/jquery.js"></script>
<link rel="stylesheet" type="text/css" href="resources/bootstrap.min.css">
<script src="resources/d3.v3.min.js"></script>
<script src="resources/topojson.v1.min.js"></script>
<script src="resources/bootstrap.min.js"></script>

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.js"></script>
<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
<body>

<div class="well scroll-right" style="width:450px" id="info">
  <h4>2012 Discharge Diagnosis Data by 3-digit <br>Zip Code</h4>
</div>
<div class="well scroll-left">
<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>
</div>

<script>
$('input[type=file]').change(function () {
    reloadMap()
});

function reloadMap(output) {

    var width = window.innerWidth, height = window.innerHeight

    var projection = d3.geo.mercator().scale(5000).translate([width/2, height/2]).center( [-76.0,43.0] )

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height) 

    var fullPath = $('input[type=file]').val()
    var file = fullPath.replace(/^.*[\\\/]/, '')

    d3.text('patient_diag/'+ file, function(datasetText) {

      var parsedCSV = d3.csv.parseRows(datasetText);

      function getLargest(){
        var largest = 0
          for(i=0;i<parsedCSV.length;i++){
            var incidence = (parsedCSV[i][1] / parsedCSV[i][2]) * 1000
            console.log(incidence)
            if(incidence>largest && incidence!==Number.POSITIVE_INFINITY) {
              largest = incidence;
            };
         };
         return largest
      };

      var quantize = d3.scale.quantize()
        .domain([0, getLargest()])
        .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));

      d3.json("ny.topojson", function(error, ny) {
        svg.append("path")
          .datum(topojson.feature(ny, ny.objects.ny))
          .attr("d", path)

      svg.selectAll("path")
        .data(topojson.feature(ny, ny.objects.ny).features)
        .enter()
        .append("path")
          .attr("title", function(d) {return d.id})
          .attr("value", function(d) {return getIncidence(d)})
          .attr("class", function(d) {return quantize(getIncidence(d))})
          .on("click", function(d) {return $('#info').html("<b>Zip:</b> " + d.id + "<br><br><b>Hospitalizations per Capita in 2012 in " + Math.floor(Number(d.id)/100) * 100 + "</b>: <br>" + getIncidence(d) + "<br><br><b>Population:</br> " + getPopulation(d))})
          .attr("d", path)

        function getIncidence(d){
          var zip = new Number(d.id)
          var zip = Math.floor(zip/100)*100
          for(i=0;i<parsedCSV.length;i++){
            if(parsedCSV[i][0]==zip){
              var incidence = (parsedCSV[i][1] / parsedCSV[i][2]) * 1000
              return incidence
            };
          };
        };

        function getPopulation(d){
          var zip = new Number(d.id)
          var zip = Math.floor(zip/100)*100
          for(i=0;i<parsedCSV.length;i++){
            if(parsedCSV[i][0]==zip){
              var population = parsedCSV[i][2]
              return population
            };
          };
        };
      });
    });
};
</script>